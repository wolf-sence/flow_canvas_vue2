<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div id ="app">
        <canvas width="1800" height="500" id="canvas" class="canvas_wrapper"></canvas>
    </div>
    <!-- <script>
        console.log('enter index')
    </script> -->
    <script async type="module">
        // import BaseV from './BaseV/instance/index.js'
        import { Engine } from './Engine/instance/engine.js';
        let root = {
            props: ['data'],

        }
        let comp1 = {
            template: '<anchor v-for="(item, index) in data.output" :output="item" :index="index"></anchor>',
            props: ['data'],
            name: 'step',
            cursor: 'pointer',
            data: function() {
                return {
                    name: 'tom',
                    age: 12,
                    obj: {
                        a: 'q',
                        b: 'w',
                        c: [1,2,3],

                    },
                    hoverColor: '#C8D8FC',
                    isHover: false,
                    isSelect: false,
                    distance: { 
                        dx: 0, // 记录拖拽时,鼠标与节点之间的距离
                        dy: 0,
                        bounds: { // 记录节点原数据
                            x: 0,
                            y: 0,
                            width: 0, 
                            height: 0,
                        }
                    }
                }
            },
            draw() {
                this.ctx.beginPath();
                // this.ctx.fillStyle=this.data.color;
                let bounds = this.data.bounds;
                this.ctx.strokeStyle = this.data.color;
                this.ctx.rect(bounds.x,bounds.y,bounds.width,bounds.height);
                this.ctx.stroke();
                this.ctx.closePath();
                let ctx = this.ctx;

                if(this.isHover) {
                    this.drawShape();
                }
                if(this.isSelect) {
                    this.drawShape();
                }
            },
            hover(isHover) {
                this.isHover = isHover;
            },
            selected(isSelect) {
                this.isSelect = isSelect;
            },
            click(cx, cy) {
                console.log('---收到单击事件---');
            },
            dblClick(cx, cy) {
                console.log('---收到双击事件---');
            },
            dragstart(x, y) {
                this.distance.dx = x - this.bounds.x;
                this.distance.dy = y - this.bounds.y;
                // 存储移动前的坐标信息
                this.distance.bounds.x = this.bounds.x;
                this.distance.bounds.y = this.bounds.y;
                this.distance.bounds.width = this.bounds.width;
                this.distance.bounds.height = this.bounds.height;
            },
            drag(x, y) {
                this.data.bounds.x = x - this.distance.dx;
                this.data.bounds.y = y - this.distance.dy;
            },
            dragend(x, y) {
                this.data.bounds.x = x - this.distance.dx;
                this.data.bounds.y = y - this.distance.dy;
                console.log('this.distancn', this.distance);
                // this.$uae.move(this.distance, this)
            },
            methods: {
                drawShape() {
                    let bounds = this.data.bounds;
                    this.ctx.beginPath();
                    this.ctx.strokeStyle = this.hoverColor;
                    this.ctx.rect(bounds.x-4,bounds.y-4,bounds.width+8,bounds.height+8);
                    this.ctx.stroke();
                    this.ctx.closePath();
                },
                output() {
                    console.log('output 1---', this.age);
                    console.log('output 1---', this.fullName);
                    console.log('output 1---', this.obj.c);
                    console.log('output data', this.data);
                },
                print() {
                    this.output();
                },
                change() {
                    this.age++;
                }
            },
            computed: {
                'bounds': function() {
                    return this.data.bounds;
                },
                'fullName': function() {
                    console.log('开始重新计算fullname')
                    return this.obj.c + '|' + this.age;
                }
            },
            watch: {
                age: function(newVal, oldVal) {
                    console.log('监听到age的改变', newVal, oldVal);
                },
                isSelect: (newVal, oldVal) => {
                    console.log('监听到 isselect 改变', newVal, oldVal)
                }
            }
        }
        let comp2 = {
            name: 'anchor',
            props: ['output', 'index'],
            cursor: 'crosshair',
            data: () => {
                return {
                    isHover: false,
                    color: '#F69E9E',
                }
            },
            draw() {
                let ctx = this.ctx;
                let data = this.$parent.data;
                ctx.beginPath();
                
                ctx.arc(this.bounds.x+this.bounds.width, this.bounds.y, this.bounds.width, 0, 2 * Math.PI);
                ctx.lineWidth = 2;
                ctx.fillStyle = 'rgb(232, 247, 249)';
                ctx.fill();
                
                ctx.strokeStyle = this.output.status == 'notExecute' ? '#C0C4CC' : this.output.color;
                ctx.stroke();
                ctx.closePath();
            },
            click(cx, cy) {
                console.log('收到 anchor的 单击事件');
            },
            // isHere(x, y) {
            //     this.createPath();
            //     return this._isHere(x, y, 3);
            // },
            computed: {
                'bounds': function() {
                    let data = this.$parent.data;
                    let pbounds = data.bounds;
                    let size = parseInt(data.bounds.width / (data.output.length + 1));
                    let r = 4;
                    // 原型绘图，坐标需要 以左上角为单位
                    let x = pbounds.x + size * (this.index + 1) - r,
                    y = pbounds.y + pbounds.height + 1;
                    return {
                        x: x,
                        y: y,
                        width: r,
                        height: r,
                    }
                },
            },
        }
        let canvas = document.getElementById('canvas');
        let uae = {
            canvas: canvas,
            data: () => {
                return {
                    name: '',
                }
            },
            methods: {
                say() {

                }
            }
        }
        let root1 = {
            color: 'black',
            id: '1',
            bounds: {
                width: 160,
                height: 40,
                x: 120,
                y: 120,
            },
            output: [
                {
                    name: "失败",
                    paramName: "failReturn",
                    criteria: "==",
                    value: "0",
                    color: "#f12626",
                    description: "失败锚点"
                },
                // {
                //     name: "成功",
                //     paramName: "sucessReturn",
                //     criteria: "==",
                //     value: "1",
                //     color: "#21c562",
                //     description: "成功出口锚点"
                // },
            ]
        }

        let root2 = {
            color: 'blue',
            id: '2',
            bounds: {
                width: 160,
                height: 40,
                x: 200,
                y: 140,
            },
            output: [
                {
                    name: "失败",
                    paramName: "failReturn",
                    criteria: "==",
                    value: "0",
                    color: "#f12626",
                    description: "失败锚点"
                },
                {
                    name: "成功",
                    paramName: "sucessReturn",
                    criteria: "==",
                    value: "1",
                    color: "#21c562",
                    description: "成功出口锚点"
                },
            ]
        }

        window.comp1 = comp1;
        
        let flow = new Engine({
            type: 'engine',
            options: uae,
        });
        flow.registerComp(comp2);
        flow.registerComp(comp1);
        flow.createNode({
            type: 'step',
            data: root1,
        })
        flow.createNode({
            type: 'step',
            data: root2,
        })
        window.flow = flow;
        window.root1 = root1;
        window.root2 = root2;
        window.c = flow.$children[0];

    </script>
</body>
<style>
    .canvas_wrapper{
        border: 1px solid black;
    }
</style>
</html>